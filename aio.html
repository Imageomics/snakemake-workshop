<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Imageomics Snakemake Workshop: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><abbr class="icon" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="text-decoration: unset">
          Â 
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #383838">Pre-Alpha
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="color: #FF4955; border-radius: 5px"></i>
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Imageomics Snakemake Workshop
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
      <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Imageomics Snakemake Workshop
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"></ul>
</li>
      </ul>
</div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
<input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset>
</form>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Imageomics Snakemake Workshop
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->
      
            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01_introduction.html">1. Introduction</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02_setup_project.html">2. Project Setup</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03_setup_env.html">3. Environment Setup</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="06_create_snakefile.html">4. Create a Workflow</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="07_filter_rule.html">5. Add an R Script</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="08_scatter_rule.html">6. Process multiple files</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="09_container_rule.html">7. Use a container</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="10_reuse_workflow.html">8. Reuse another workflow</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="11_summary_rule.html">9. Add Summary Analysis</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="12_run_on_slurm.html">10. Run at Scale</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">
            
            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01_introduction"><p>Content from <a href="01_introduction.html">Introduction</a></p>
<hr>
<p> Last updated on 2023-03-22 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/01_introduction.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Why not use a general purpose language like bash or python for
writing workflows?</li>
<li>What problems do workflow languages solve?</li>
<li>What are the strengths and weaknesses of Snakemake?</li>
<li>What will be covered in this workshop?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand why one would use a workflow language like Snakemake</li>
<li>Understand the goals of the workshop</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="workflow-challenges"><h2 class="section-heading">Workflow Challenges<a class="anchor" aria-label="anchor" href="#workflow-challenges"></a>
</h2>
<hr class="half-width">
<p>Using a general purpose language like bash or python can be
challenging:</p>
<ul>
<li>Not re-running the whole pipeline every time</li>
<li>Adapting the pipeline to run in different environments</li>
<li>Providing dependencies for tools</li>
<li>Tracking progress of the workflow</li>
</ul></section><section id="workflow-language-features"><h2 class="section-heading">Workflow language features<a class="anchor" aria-label="anchor" href="#workflow-language-features"></a>
</h2>
<hr class="half-width">
<ul>
<li>Portable</li>
<li>Reproducible</li>
<li>Scalable</li>
<li>Reusable</li>
</ul>
<p>List of workflow languages: <a href="https://workflows.community/systems" class="external-link uri">https://workflows.community/systems</a></p>
</section><section id="strengths-of-snakemake"><h2 class="section-heading">Strengths of Snakemake<a class="anchor" aria-label="anchor" href="#strengths-of-snakemake"></a>
</h2>
<hr class="half-width">
<ul>
<li>Readability</li>
<li>Only creates missing or out of date files</li>
<li>Flexible control over which files are created</li>
<li>Is python with some additional rule syntax</li>
<li>Dynamic branching
<ul>
<li>Workflow isnât fixed at start up.</li>
<li>Outputs of commands can be used determined what happens next.</li>
</ul>
</li>
</ul></section><section id="weaknesses-of-snakemake"><h2 class="section-heading">Weaknesses of Snakemake<a class="anchor" aria-label="anchor" href="#weaknesses-of-snakemake"></a>
</h2>
<hr class="half-width">
<ul>
<li>Requires learning rule based logic instead of procedural logic</li>
<li>Requires some python code/knowledge for typical workflows</li>
</ul></section><section id="class-plan"><h2 class="section-heading">Class Plan<a class="anchor" aria-label="anchor" href="#class-plan"></a>
</h2>
<hr class="half-width">
<ul>
<li>Create Snakemake Workflow that
<ul>
<li>Runs R scripts for filtering and final analysis</li>
<li>Runs Machine Learning Components</li>
<li>Efficiently processes many files at the same time</li>
<li>Reuses an existing Snakemake workflow</li>
</ul>
</li>
</ul>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 --></section></section><section id="aio-02_setup_project"><p>Content from <a href="02_setup_project.html">Project Setup</a></p>
<hr>
<p> Last updated on 2023-03-21 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/02_setup_project.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I create a directory with the necessary files for this
class?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Connect to OSC</li>
<li>Create a directory</li>
<li>Open a Web Terminal in that Directory</li>
<li>Copy lesson files into place</li>
<li>Copy cached singularity images into place</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="log-into-osc"><h2 class="section-heading">Log into OSC<a class="anchor" aria-label="anchor" href="#log-into-osc"></a>
</h2>
<hr class="half-width">
<ul>
<li>Visit <a href="https://ondemand.osc.edu/" class="external-link uri">https://ondemand.osc.edu/</a>.</li>
<li>Login with your credentials.</li>
<li>From the top menu select <strong>Files</strong> -&gt; <strong>Home
Directory</strong>
</li>
<li>Click the <strong>New Directory</strong> button
<ul>
<li>Enter <code>SnakemakeWorkflow</code> for the directory name</li>
</ul>
</li>
<li>Click âSnakemakeWorkflowâ in the <strong>Name</strong> column the
list of files and folders</li>
<li>Click âOpen in Terminalâ</li>
</ul></section><section id="copy-lesson-files"><h2 class="section-heading">Copy Lesson Files<a class="anchor" aria-label="anchor" href="#copy-lesson-files"></a>
</h2>
<hr class="half-width">
<p>Some files are provided for this lesson. These files need to be
copied into the âSnakemakeWorkflowâ subdirectory within your home
directory. You should be within the <code>SnakemakeWorkflow</code>
directory before running this step.</p>
<div class="section level3">
<h3 id="verify-directory">Verify Directory<a class="anchor" aria-label="anchor" href="#verify-directory"></a>
</h3>
<p>Run the following command to ensure you are in the appropriate
directory:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">pwd</span></span></code></pre>
</div>
<p>The output should look similar to the following:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/users/PAS2136/jbradley/SnakemakeWorkflow</code></pre>
</div>
</div>
<div class="section level3">
<h3 id="copy-files">Copy Files<a class="anchor" aria-label="anchor" href="#copy-files"></a>
</h3>
<p>Run the following command to copy these files into your current
directory (SnakemakeWorkflow):</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> <span class="at">-r</span> /fs/ess/PAS2136/Workshops/Snakemake/files/<span class="pp">*</span> .</span></code></pre>
</div>
<p>Next run the <code>ls</code> command to ensure you have all the
needed files:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span></span></code></pre>
</div>
<p>Expected Output:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>multimedia.csv  run-workflow.sh  Scripts  slurm</code></pre>
</div>
</div>
<div class="section level3">
<h3 id="lesson-files">Lesson Files<a class="anchor" aria-label="anchor" href="#lesson-files"></a>
</h3>
<ul>
<li>
<strong>multimedia.csv</strong> - Main input file of fish images
used by the workflow</li>
<li>
<strong>Scripts/</strong>
<ul>
<li>
<strong>setup_env.sh</strong> - Used to activates snakemake conda
environment and other utilities</li>
<li>
<strong>FilterImagesHardCoded.R</strong> - Rscript that filters a
CSV for a target species with hard coded filenames</li>
<li>
<strong>FilterImages.R</strong> - R script that filters a CSV for a
target species</li>
<li>
<strong>SummaryReport.R</strong> - R script that builds a summary
report of the workflow outputs</li>
<li>
<strong>Summary.Rmd</strong> - R markdown script used by
SummaryReport.R to create a report</li>
</ul>
</li>
<li>run-workflow.sh - sbatch script used to run the workflow using
SLURM</li>
<li>
<strong>slurm/</strong> - Directory containing a config file used by
Snakemake to run SLURM jobs</li>
</ul>
<p>The main input file (<code>multimedia.csv</code>) was downloaded from
<a href="https://bgnn.tulane.edu" class="external-link uri">https://bgnn.tulane.edu</a>.</p>
</div>
</section><section id="setup-snakemake-singularity-cache"><h2 class="section-heading">Setup Snakemake Singularity Cache<a class="anchor" aria-label="anchor" href="#setup-snakemake-singularity-cache"></a>
</h2>
<hr class="half-width">
<p>To avoid waiting for singularity containers to pull we will copy
cached containers inline.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> .snakemake/singularity</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /fs/ess/PAS2136/Workshops/Snakemake/singularity_images/<span class="pp">*</span> .snakemake/singularity/.</span></code></pre>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-03_setup_env"><p>Content from <a href="03_setup_env.html">Environment Setup</a></p>
<hr>
<p> Last updated on 2023-03-20 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/03_setup_env.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I setup an shell environment to use Snakemake?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Start an interactive session on a worker node</li>
<li>Setup the shell environment</li>
<li>Verify versions of snakemake and R</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="start-interactive-session"><h2 class="section-heading">Start Interactive Session<a class="anchor" aria-label="anchor" href="#start-interactive-session"></a>
</h2>
<hr class="half-width">
<p>Since we will be running some heavy processing starting an
interactive job is important. Otherwise this processing would occcur on
a login node and cause issues for other cluster users.</p>
<p>Start an interactive session that will remain active for 1 hour of by
running:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sinteractive</span> <span class="at">-t</span> 01:00:00 <span class="at">-A</span> PAS2136</span></code></pre>
</div>
</section><section id="software-environment-setup"><h2 class="section-heading">Software Environment Setup<a class="anchor" aria-label="anchor" href="#software-environment-setup"></a>
</h2>
<hr class="half-width">
<p>Run the following steps from within an OSC ondemand terminal within
the âSnakemakeWorkflowâ subdirectory.</p>
<p>Activate the Snakemake environment:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span> Scripts/setup_env.sh</span></code></pre>
</div>
<p>NOTE: The leading dot followed by a space is important. This causes
the settings in setup_env.sh to be applied to your current terminal
session.</p>
<p>Expected Output:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Activating R module that can be used with R scripts.
This module will switch Compiler environment to gnu/11.2.0 and load mkl/2021.3.0 for R/4.2.1
Lmod is automatically replacing "intel/19.0.5" with "gnu/11.2.0".
The following have been reloaded with a version change:
  1) mvapich2/2.3.3 =&gt; mvapich2/2.3.6
Configuring R to use the yaml package.
Configuring singularity to use a cache to speed up pulling containers.</code></pre>
</div>
<p>Test snakemake with the âversion flag</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--version</span></span></code></pre>
</div>
<p>Expected Output:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>7.22.0</code></pre>
</div>
<p>Test R âversion flag</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> <span class="at">--version</span></span></code></pre>
</div>
<p>Expected Output:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>R version 4.2.1 ...</code></pre>
</div>
<div id="new-terminal-sessions" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="new-terminal-sessions" class="callout-inner">
<h3 class="callout-title">New Terminal Sessions<a class="anchor" aria-label="anchor" href="#new-terminal-sessions"></a>
</h3>
<div class="callout-content">
<p>If you close your terminal, create a new terminal, or reach the 1
hour timeout you will need to setup your environment again. To do so
rerun the following two steps:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sinteractive</span> <span class="at">-t</span> 01:00:00 <span class="at">-A</span> PAS2136</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span> Scripts/setup_env.sh</span></code></pre>
</div>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-06_create_snakefile"><p>Content from <a href="06_create_snakefile.html">Create a Workflow</a></p>
<hr>
<p> Last updated on 2023-03-20 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/06_create_snakefile.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do you create a Snakemake Workflow?</li>
<li>How do you run a Snakemake Workflow?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Create a workflow with a single rule</li>
<li>Run a snakemake workflow</li>
<li>Understand snakemake output</li>
<li>Reduce filename duplication using <strong>wildcards</strong>
</li>
<li>Represent non-file inputs using a <strong>param</strong>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="snakemake-workflow"><h2 class="section-heading">Snakemake Workflow<a class="anchor" aria-label="anchor" href="#snakemake-workflow"></a>
</h2>
<hr class="half-width">
<p>A Snakemake workflow is a list of rules.</p>
<p>Commonly used parts of a rule are:</p>
<ul>
<li>
<strong>name</strong> - unique name for a rule</li>
<li>
<strong>input</strong> - input filenames used by a command</li>
<li>
<strong>params</strong> - non-file input values used by a
command</li>
<li>
<strong>output</strong> - output filenames created by a command</li>
<li>
<strong>container</strong> - singularity container to run command
within</li>
<li>
<strong>shell</strong> - command to run</li>
</ul>
<p>Rule pattern:</p>
<pre><code>rule &lt;name&gt;:
    input: ...
    params: ...
    output: ...
    container: ...
    shell: ...
</code></pre>
</section><section id="create-a-snakemake-workflow"><h2 class="section-heading">Create a Snakemake Workflow<a class="anchor" aria-label="anchor" href="#create-a-snakemake-workflow"></a>
</h2>
<hr class="half-width">
<p>For our first step we will reduce the size of the
<strong>multimedia.csv</strong> input file saving the result as
<strong>reduce/multimedia.csv</strong>. This CSV file contains a header
line followed by data lines. So to save the first 10 data lines we will
need the first 11 lines in total. This can be accomplished with the
shell <code>head</code> command passing the <code>--n 11</code>
argument. Run the following command in your terminal to see the first 11
lines printed out.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span> <span class="at">-n</span> 11 multimedia.csv</span></code></pre>
</div>
<p>To save this output we will change the command like so:</p>
<p><code>head -n 11 multimedia.csv &gt; reduce/multimedia.csv</code></p>
<p>Create a text file named <code>Snakefile</code> with the following
contents:</p>
<pre><code>rule reduce:
    input: "multimedia.csv"
    output: "reduce/multimedia.csv"
    shell: "head -n 11 multimedia.csv &gt; reduce/multimedia.csv"</code></pre>
<p>This code creates a Snakemake rule named <strong>reduce</strong> with
a input file <strong>multimedia.csv</strong>, a output file
<strong>reduce/multimedia.csv</strong>, and the shell command from
above. Snakemake will automatically create the reduce directory for us
before running the shell command. A common pattern is to output files in
a directory named after the rule. This will help you keep track of which
rule created a specific file.</p>
</section><section id="run-the-workflow"><h2 class="section-heading">Run the Workflow<a class="anchor" aria-label="anchor" href="#run-the-workflow"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span></span></code></pre>
</div>
<p>Expected Error Output:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Error: you need to specify the maximum number of CPU cores 
to be used at the same time. If you want to use N cores, 
say --cores N or -cN. For all cores on your system 
(be sure that this is appropriate) use --cores all. 
For no parallelization use --cores 1 or -c1....</code></pre>
</div>
<p>The <code>snakemake</code> command has a single required argument
that specifies how manu CPU cores to use when running a workflow. Until
we want to scale up our workflow we are fine using 1 core.</p>
<p>Run snakemake specifying 1 core:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span></span></code></pre>
</div>
<p>Expected Output:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Using shell: /usr/bin/bash
Provided cores: 1 (use --cores to define parallelism)
Rules claiming more threads will be scaled down.
Job stats:
job       count    min threads    max threads
------  -------  -------------  -------------
reduce        1              1              1
total         1              1              1
Select jobs to execute...
[Mon Feb 27 11:28:29 2023]
rule reduce:
    input: multimedia.csv
    output: reduce/multimedia.csv
    jobid: 0
    reason: Missing output files: reduce/multimedia.csv
    resources: tmpdir=/tmp
[Mon Feb 27 11:28:29 2023]
Finished job 0.
1 of 1 steps (100%) done
Complete log: .snakemake/log/2023-02-27T112816.505955.snakemake.log</code></pre>
</div>
<p>Notice the <strong>reason</strong> logging
<code>Missing output files: reduce/multimedia.csv</code>. This tells you
why snakemake is running this rule. In this case it is because the
output file reduce/multimedia.csv is missing.</p>
<p>Try running the workflow again:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span></span></code></pre>
</div>
<p>Expected Output:</p>
<pre><code>Building DAG of jobs...
Nothing to be done (all requested files are present and up to date).
Complete log: .snakemake/log/2023-02-27T113325.906186.snakemake.log</code></pre>
</section><section id="reduce-duplication-using-wildcards"><h2 class="section-heading">Reduce duplication using wildcards<a class="anchor" aria-label="anchor" href="#reduce-duplication-using-wildcards"></a>
</h2>
<hr class="half-width">
<p>Within the <code>shell</code> command the <strong>input</strong> and
<strong>output</strong> files can be referenced using wildcards. This
will reduce duplication simplifing filename changes.</p>
<p>Change the <code>shell</code> line in the <code>Snakefile</code> as
follows:</p>
<pre><code>rule reduce:
    input: "multimedia.csv"
    output: "reduce/multimedia.csv"
    shell: "head -n 11 {input} &gt; {output}"</code></pre>
</section><section id="represent-non-file-inputs-using-a-param"><h2 class="section-heading">Represent non-file inputs using a param<a class="anchor" aria-label="anchor" href="#represent-non-file-inputs-using-a-param"></a>
</h2>
<hr class="half-width">
<p>Currently the reduce rule grabs the top 11 rows. Since the meaning of
this number may not be obvious and we are likely to change this number
in the future a better option is to use this non-file input as a
param.</p>
<p>Add a new <code>params</code> setting to the <code>rule</code> and
use the <code>params.rows</code> wildcard in the shell as follows:</p>
<pre><code>rule reduce:
  input: "multimedia.csv"
  params: rows="11"  
  output: "reduce/multimedia.csv"
  shell: "head -n {params.rows} {input} &gt; {output}"</code></pre>
<p>Notice how we assigned a name ârowsâ to the parameter. Assigning a
name like this can also be done for the input and output filenames as
well.</p>
<p>Try running the workflow again:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span></span></code></pre>
</div>
<p>Notice the <strong>reason</strong> has changed</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>...
    reason: Code has changed since last execution; Params have changed since last execution
...</code></pre>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-07_filter_rule"><p>Content from <a href="07_filter_rule.html">Add an R Script</a></p>
<hr>
<p> Last updated on 2023-03-20 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/07_filter_rule.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I create a rule using an RStudio friendly R script?</li>
<li>How can I control what files Snakemake creates?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Create a rule that uses an RStudio friendly R script.</li>
<li>Run snakemake specifying a <strong>target output file</strong>
</li>
<li>Create an <strong>all</strong> rule to control the default output
files</li>
<li>Use a <strong>YAML config file</strong> to avoid filename
duplication</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="rstudio-friendly-rules"><h2 class="section-heading">RStudio friendly Rules<a class="anchor" aria-label="anchor" href="#rstudio-friendly-rules"></a>
</h2>
<hr class="half-width">
<p>Next we want to add an R script that will filter an input CSV file
for the species of our choosing. We want this R script to be easily
runnable within RStudio. To accomplish this we want to avoid passing
command line arguments to the R script as this is difficult to
accommodate within RStudio.</p>
</section><section id="see-the-hard-coded-paths-in-the-r-script"><h2 class="section-heading">See the hard coded paths in the R script<a class="anchor" aria-label="anchor" href="#see-the-hard-coded-paths-in-the-r-script"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span> Scripts/FilterImagesHardCoded.R</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">input_path</span> <span class="op">&lt;-</span> <span class="st">"reduce/multimedia.csv"</span></span>
<span><span class="va">output_path</span> <span class="op">&lt;-</span> <span class="st">"filter/multimedia.csv"</span></span>
<span><span class="va">...</span></span></code></pre>
</div>
</section><section id="run-a-filtering-r-script"><h2 class="section-heading">Run a filtering R script<a class="anchor" aria-label="anchor" href="#run-a-filtering-r-script"></a>
</h2>
<hr class="half-width">
<p>Add a new rule to the bottom of <code>Snakefile</code>:</p>
<pre><code>rule filter:
  input: 
      script="Scripts/FilterImagesHardCoded.R",
      fishes="reduce/multimedia.csv"
  output: "filter/multimedia.csv"
  shell: "Rscript {input.script}"</code></pre>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span></span></code></pre>
</div>
<p>Expected Output:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Nothing to be done (all requested files are present and up to date).
Complete log: .snakemake/log/2023-02-28T164348.500545.snakemake.log</code></pre>
</div>
<p>Snakemake didnât create the <code>filter/multimedia.csv</code>.</p>
</section><section id="snakemake-target-files"><h2 class="section-heading">Snakemake Target Files<a class="anchor" aria-label="anchor" href="#snakemake-target-files"></a>
</h2>
<hr class="half-width">
<p>When Snakemake starts up it first determines a set of target files to
create. By default the target files are determined from the first rule
unless filenames are passed along the command line to snakemake. After
determining the target files Snakemake looks through the rules and
creates job plan (called a DAG) to create the desired target.</p>
</section><section id="create-a-desired-file"><h2 class="section-heading">Create a desired file<a class="anchor" aria-label="anchor" href="#create-a-desired-file"></a>
</h2>
<hr class="half-width">
<p>For our workflow the first rule is the <strong>reduce</strong> rule.
To change the target file you can just pass it as an argument to
snakemake. This is a nice way to build different files from your
workflow when developing it.</p>
<p>Run snakemake specifying <code>filter/multimedia.csv</code> as the
target.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span> filter/multimedia.csv</span></code></pre>
</div>
</section><section id="run-snakemake-specifying-a-non-existant-target"><h2 class="section-heading">Run snakemake specifying a non-existant target<a class="anchor" aria-label="anchor" href="#run-snakemake-specifying-a-non-existant-target"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span> winninglotterynumbers.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
MissingRuleException:
No rule to produce winninglotterynumbers.txt (if you use input functions make sure that they don't raise unexpected exceptions).</code></pre>
</div>
</section><section id="add-a-default-rule"><h2 class="section-heading">Add a default rule<a class="anchor" aria-label="anchor" href="#add-a-default-rule"></a>
</h2>
<hr class="half-width">
<p>At the top of Snakefile add a new rule</p>
<pre><code>rule all:
    input: "filter/multimedia.csv"</code></pre>
<p>Test it out by removing filter/multimedia.csv and running snakemake
with no target</p>
<pre><code>rm filter/multimedia.csv
snakemake -c1</code></pre>
</section><section id="see-how-the-r-script-reads-from-the-config-file"><h2 class="section-heading">See how the R script reads from the config file:<a class="anchor" aria-label="anchor" href="#see-how-the-r-script-reads-from-the-config-file"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span> Scripts/FilterImages.R</span></code></pre>
</div>
</section><section id="use-a-config-file-to-avoid-filename-duplication"><h2 class="section-heading">Use a config file to avoid filename duplication<a class="anchor" aria-label="anchor" href="#use-a-config-file-to-avoid-filename-duplication"></a>
</h2>
<hr class="half-width">
<p>A better option to allow easy changes to the rows param is to store
this value in a config file. Snakemake comes with support for parsing
and using a YAML config file.</p>
<p>Create a new file named <code>config.yaml</code> with the following
contents:</p>
<pre><code><span><span class="va">reduce_multimedia</span><span class="op">:</span> <span class="va">reduce</span><span class="op">/</span><span class="va">multimedia.csv</span></span>
<span><span class="va">filter_multimedia</span><span class="op">:</span> <span class="va">filter</span><span class="op">/</span><span class="va">multimedia.csv</span></span></code></pre>
<p>Then update your <code>Snakefile</code> to adding the config file
location and using <code>config.yaml</code> to lookup filenames:</p>
<pre><code>configfile: "config.yaml"

rule all:
    input: config["filter_multimedia"]

rule reduce:
  input: "multimedia.csv"
  params: rows="11"
  output: config["reduce_multimedia"]
  shell: "head -n {params.rows} {input} &gt; {output}"

rule filter:
  input: 
      script="Scripts/FilterImages.R",
      fishes=config["reduce_multimedia"]
  output: config["filter_multimedia"]
  shell: "Rscript {input.script}"</code></pre>
<p>Running the workflow again:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span></span></code></pre>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-08_scatter_rule"><p>Content from <a href="08_scatter_rule.html">Process multiple files</a></p>
<hr>
<p> Last updated on 2023-03-21 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/08_scatter_rule.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I check a Snakefile without running the whole workflow?</li>
<li>How can I create a generic rule that can process multiple
files?</li>
<li>How can I use a python function as part of a rule?</li>
<li>How do I tell snakemake to create a certain file before running a
python function?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Determine a filename plan to download images</li>
<li>Create a pattern rule to download multiple image files</li>
<li>Use a python function as a params input</li>
<li>Setup a <strong>checkpoint</strong> to ensure a file exists before
running a python function.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="snakemake-dry-run"><h2 class="section-heading">Snakemake Dry Run<a class="anchor" aria-label="anchor" href="#snakemake-dry-run"></a>
</h2>
<hr class="half-width">
<p>When developing a workflow running the entire workflow after every
change can be time intensive. To help with this snakemake has a
<code>--dry-run</code> flag that will validate the
<code>Snakefile</code> and show what it would do. Try this now:</p>
<pre><code><span><span class="va">snakemake</span> <span class="op">-</span><span class="va">c1</span> <span class="op">-</span><span class="op">-</span><span class="va">dry</span><span class="op">-</span><span class="va">run</span></span></code></pre>
</section><section id="create-a-filename-plan-to-save-images"><h2 class="section-heading">Create a filename plan to save images<a class="anchor" aria-label="anchor" href="#create-a-filename-plan-to-save-images"></a>
</h2>
<hr class="half-width">
<p>When downloading images from the internet it is important to avoid
filename clashes. To avoid this problem deciding on a plan for naming
the files is important.</p>
<p>The input CSV (<code>multimedia.csv</code>) was downloaded from <a href="https://bgnn.tulane.edu/userinterface/" class="external-link uri">https://bgnn.tulane.edu/userinterface/</a>. This
<code>multimedia.csv</code> file we are using is only meant to be used
for this workshop and should not be used for any particular research
purpose. To create a real world dataset you could use the <a href="https://fishair.org/" class="external-link uri">https://fishair.org/</a> website
that replaces the website I used to download this file.</p>
<p>When viewed within RStudio the data looks like this: <img src="files/multimedia.png" alt="multimedia CSV screenshot" class="figure"></p>
<p>The <a href="https://bgnn.tulane.edu/" class="external-link">Tulane multimedia.csv
documentation</a> describes the <code>arkID</code> column as:</p>
<blockquote>
<p>Multimedia unique identifier number</p>
</blockquote>
<p><strong>arkID</strong> seems like a good identifier to use in our
image filenames.</p>
<p>For the multimedia row with arkID <code>dd216t3d</code> we will save
the downloaded image as:</p>
<pre><code><span><span class="va">Images</span><span class="op">/</span><span class="va">dd216t3d.jpg</span></span></code></pre>
</section><section id="use-wget-to-download-an-image"><h2 class="section-heading">Use wget to download an image<a class="anchor" aria-label="anchor" href="#use-wget-to-download-an-image"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> <span class="at">-O</span> test.jpg https://bgnn.tulane.edu/hdr-share/ftp/ark/89609/GLIN/FMNH/dd216t3d.jpg</span></code></pre>
</div>
</section><section id="create-a-rule-that-uses-a-python-function"><h2 class="section-heading">Create a rule that uses a python function<a class="anchor" aria-label="anchor" href="#create-a-rule-that-uses-a-python-function"></a>
</h2>
<hr class="half-width">
<p>Add a rule to download a single image that uses a python function
param:</p>
<pre><code>def get_image_url(wildcards):
    base_image_url = "https://bgnn.tulane.edu/hdr-share/ftp/ark/89609/GLIN/FMNH/"
    return base_image_url + "dd216t3d.jpg"

rule download_image:
    params: url=get_image_url    
    output: "Images/dd216t3d.jpg"
    shell: "wget -O {output} {params.url}"</code></pre>
<p>NOTE: Make sure you are using <code>-O</code> and not <code>-o</code>
for the <code>wget</code> argument.</p>
</section><section id="make-the-rule-generic-with-a-pattern-rule"><h2 class="section-heading">Make the rule generic with a pattern rule<a class="anchor" aria-label="anchor" href="#make-the-rule-generic-with-a-pattern-rule"></a>
</h2>
<hr class="half-width">
<p>Change this rule to be a pattern rule by adding a wildcard expression
in an output filename.</p>
<pre><code>def get_image_url(wildcards):
    base_url = "https://bgnn.tulane.edu/hdr-share/ftp/ark/89609/GLIN/FMNH/"
    return base_url + wildcards.ark_id + ".jpg"

rule download_image:
    params: url=get_image_url    
    output: "Images/{ark_id}.jpg"
    shell: "wget -O {output} {params.url}"</code></pre>
<p>Run this rule:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span> <span class="at">--dry-run</span> Images/hd529k3h.jpg</span></code></pre>
</div>
</section><section id="add-python-logic-to-lookup-the-url"><h2 class="section-heading">Add python logic to lookup the URL<a class="anchor" aria-label="anchor" href="#add-python-logic-to-lookup-the-url"></a>
</h2>
<hr class="half-width">
<p>Add a pandas import to the top of <code>Snakefile</code>:</p>
<pre><code>import pandas as pd</code></pre>
<p>Change the <code>get_image_url</code> function to read the CSV file
and add the file as a rule input:</p>
<pre><code>def get_image_url(wildcards):
    filename = "multimedia.csv"
    df = pd.read_csv(filename)
    row = df[df["arkID"] == wildcards.ark_id]
    url = row["accessURI"].item()
    return url

rule download_image:
    params: url=get_image_url    
    output: "Images/{ark_id}.jpg"
    shell: "wget -O {output} {params.url}"</code></pre>
<p>Run snakemake:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span> <span class="at">--dry-run</span> Images/hd529k3h.jpg</span></code></pre>
</div>
</section><section id="updating-all-rule"><h2 class="section-heading">Updating all rule<a class="anchor" aria-label="anchor" href="#updating-all-rule"></a>
</h2>
<hr class="half-width">
<p>Update the all rule adding a function that returns the list of all
images that should be created.</p>
<pre><code>def get_image_filenames(wildcards):
    filename = config["filter_multimedia"]
    df = pd.read_csv(filename)    
    ark_ids = df["arkID"].tolist()
    return expand("Images/{ark_id}.jpg", ark_id=ark_ids)

rule all:
    input: get_image_filenames</code></pre>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span></span></code></pre>
</div>
</section><section id="test-starting-from-scratch"><h2 class="section-heading">Test starting from scratch<a class="anchor" aria-label="anchor" href="#test-starting-from-scratch"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> reduce filter Images</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
FileNotFoundError in file /users/PAS2136/jbradley/SnakemakeWorkflow/Snakefile, line 7:
[Errno 2] No such file or directory: 'filter/multimedia.csv'
...</code></pre>
</div>
</section><section id="require-a-file-exists-before-a-python-function-is-used"><h2 class="section-heading">Require a file exists before a python function is used<a class="anchor" aria-label="anchor" href="#require-a-file-exists-before-a-python-function-is-used"></a>
</h2>
<hr class="half-width">
<p>To fix the <strong>FileNotFoundError</strong> error we need to inform
Snakemake that it needs to wait for the
<code>filter/multimedia.csv</code> file to be created before Snakemake
runs the function.</p>
<p>We need two changes to fix the error:</p>
<ol style="list-style-type: decimal">
<li>Change the <strong>filter</strong> rule to be a checkpoint instead
of a simple rule. This is done by changing the word âruleâ to
âcheckpointâ.</li>
<li>Add code to the function requesting the output of the
<code>filter</code> checkpoint.</li>
</ol>
<p>Update the <code>get_image_filenames</code> function and
<code>filter</code> rule/checkpoint as follows:</p>
<pre><code>def get_image_filenames(wildcards):
    filename = checkpoints.filter.get().output[0]
    df = pd.read_csv(filename)    
    ark_ids = df["arkID"].tolist()
    return expand("Images/{ark_id}.jpg", ark_id=ark_ids)
...

checkpoint filter:
  input: 
      script="Scripts/FilterImages.R",
      fishes=config["reduce_multimedia"]
  output: config["filter_multimedia"]
  shell: "Rscript {input.script}"</code></pre>
</section><section id="run-downloading-multiple-files"><h2 class="section-heading">Run downloading multiple files<a class="anchor" aria-label="anchor" href="#run-downloading-multiple-files"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span></span></code></pre>
</div>
</section><section id="ensure-the-downloaded-files-are-jpg"><h2 class="section-heading">Ensure the downloaded files are jpg<a class="anchor" aria-label="anchor" href="#ensure-the-downloaded-files-are-jpg"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file</span> Images/<span class="pp">*</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Images/88624536.jpg: JPEG image data, EXIF standard
Images/9x56f44c.jpg: JPEG image data, EXIF standard
Images/bj373514.jpg: JPEG image data, EXIF standard
Images/dp60604r.jpg: JPEG image data, EXIF standard
Images/hd529k3h.jpg: JPEG image data, EXIF standard
Images/t868dr68.jpg: JPEG image data, EXIF standard</code></pre>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-09_container_rule"><p>Content from <a href="09_container_rule.html">Use a container</a></p>
<hr>
<p> Last updated on 2023-03-20 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/09_container_rule.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I make my workflow more reproducible?</li>
<li>How do you use a docker image with Snakemake?</li>
<li>How do I enable containers with snakemake?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Use a container in a rule</li>
<li>Run snakemake with the âuse-singularity argument</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="snakemake-dependency-management"><h2 class="section-heading">Snakemake dependency management<a class="anchor" aria-label="anchor" href="#snakemake-dependency-management"></a>
</h2>
<hr class="half-width">
<ul>
<li>containers
<ul>
<li>exact software versions on later installs</li>
<li>support for
<ul>
<li>docker container images</li>
<li>singularity container images</li>
</ul>
</li>
</ul>
</li>
<li>conda environments
<ul>
<li>may result in different software versions on later installs</li>
<li>powerful but might not install in every environment</li>
</ul>
</li>
</ul></section><section id="singularity-container-image-uri"><h2 class="section-heading">Singularity Container Image URI<a class="anchor" aria-label="anchor" href="#singularity-container-image-uri"></a>
</h2>
<hr class="half-width">
<p>Pulling a container with docker (wonât work on OSC):</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull alpine:3</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>bash: docker: command not found</code></pre>
</div>
<p>Pulling a docker container with singularity:</p>
<pre><code>singularity pull docker://alpine:3</code></pre>
<p>Singularity supports multiple container types so you must prefix
docker container image URIs with <code>docker://</code>.</p>
</section><section id="use-container-when-downloading-images"><h2 class="section-heading">Use container when downloading images<a class="anchor" aria-label="anchor" href="#use-container-when-downloading-images"></a>
</h2>
<hr class="half-width">
<p>Update the download_image rule to use the docker container image URI
<code>quay.io/biocontainers/gnu-wget:1.18--h60da905_7</code>.</p>
<pre><code>rule download_image:
    params: url=get_image_url    
    output:'Images/{ark_id}.jpg'
    container: "docker://quay.io/biocontainers/gnu-wget:1.18--h60da905_7"    
    shell: "wget -O {output} {params.url}"</code></pre>
<p>NOTE: You must put the <code>container</code> line before the
<code>shell</code> line.</p>
<p>Delete an image then run snakemake passing the âuse-singularity
flag</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> Images/hd529k3h.jpg</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span> <span class="at">--use-singularity</span> Images/hd529k3h.jpg</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Pulling singularity image docker://quay.io/biocontainers/gnu-wget:1.18--h60da905_7.
Using shell: /usr/bin/bash
...
Activating singularity image /users/PAS2136/jbradley/SnakemakeWorkflow/.snakemake/singularity/3a63838ec9e2427957182dedc234c8d7.simg
...</code></pre>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-10_reuse_workflow"><p>Content from <a href="10_reuse_workflow.html">Reuse another workflow</a></p>
<hr>
<p> Last updated on 2023-03-20 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/10_reuse_workflow.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is needed to re-use another Snakemake workflow?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Re-use parts of the BGNN_Core_Workflow Snakemake Workflow</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="reusing-another-workflow"><h2 class="section-heading">Reusing Another Workflow<a class="anchor" aria-label="anchor" href="#reusing-another-workflow"></a>
</h2>
<hr class="half-width">
<p>To re-use a workflow you generally need:</p>
<ul>
<li>Where to find workflow? - github âhdr-bgnn/BGNN_Core_Workflowâ</li>
<li>What is the relative path to the Snakefile?
âworkflow/Snakefileâ</li>
<li>What tag or version to use? â1.0.0â</li>
<li>What file naming convention is the workflow using?</li>
<li>What dependencies must be manually installed?</li>
</ul>
<p>See source code for the workflow <a href="https://github.com/hdr-bgnn/BGNN_Core_Workflow/blob/main/workflow/Snakefile#L19" class="external-link uri">https://github.com/hdr-bgnn/BGNN_Core_Workflow/blob/main/workflow/Snakefile#L19</a></p>
<p>If there is a filename mismatch you can either change your workflow
or override settings in the rule.</p>
<pre><code>module bgnn_core:
    snakefile:
        github("hdr-bgnn/BGNN_Core_Workflow", path="workflow/Snakefile", tag="1.0.0")

use rule generate_metadata from bgnn_core</code></pre>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span> <span class="at">--use-singularity</span> DrexelMetadata/bj373514.json</span></code></pre>
</div>
</section><section id="bring-in-additional-rules-from-bgnn_core_workflow"><h2 class="section-heading">Bring in additional rules from BGNN_Core_Workflow<a class="anchor" aria-label="anchor" href="#bring-in-additional-rules-from-bgnn_core_workflow"></a>
</h2>
<hr class="half-width">
<pre><code>use rule transform_metadata from bgnn_core
use rule crop_image from bgnn_core
use rule segment_image from bgnn_core</code></pre>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span> <span class="at">--use-singularity</span> Segmented/hd529k3h_segmented.png</span></code></pre>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-11_summary_rule"><p>Content from <a href="11_summary_rule.html">Add Summary Analysis</a></p>
<hr>
<p> Last updated on 2023-03-20 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/11_summary_rule.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we specify a rule that has many dynamic input files?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Add a summary rule that requires Segmented images</li>
<li>Use expand function to simplify creating filenames</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Add summary_report to config.yaml:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span> Scripts/SummaryReport.R</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">yaml</span><span class="fu">::</span><span class="fu">read_yaml</span><span class="op">(</span>file <span class="op">=</span> <span class="st">"config.yaml"</span><span class="op">)</span></span>
<span><span class="va">filtered_images_path</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">filter_multimedia</span></span>
<span><span class="va">output_path</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">summary_report</span></span>
<span></span>
<span><span class="va">filtered_images</span> <span class="op">&lt;-</span> <span class="fu">read.csv</span><span class="op">(</span>file <span class="op">=</span> <span class="va">filtered_images_path</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dir.create</span><span class="op">(</span><span class="fu">dirname</span><span class="op">(</span><span class="va">output_path</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu">render</span><span class="op">(</span><span class="st">"Scripts/Summary.Rmd"</span>, output_file<span class="op">=</span><span class="fu">basename</span><span class="op">(</span><span class="va">output_path</span><span class="op">)</span>, output_dir<span class="op">=</span><span class="fu">dirname</span><span class="op">(</span><span class="va">output_path</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Edit config.yaml adding <strong>summary_report</strong>:</p>
<pre><code><span><span class="va">summary_report</span><span class="op">:</span> <span class="va">summary</span><span class="op">/</span><span class="va">report.html</span></span></code></pre>
<p>Change the <code>all</code> rule to require
<code>summary/report.html</code> in <code>Snakefile</code>:</p>
<pre><code>rule all:
    inputs: config["summary_report"]</code></pre>
<p>Add a new function that gathers the inputs for the summary rule and a
<code>summary</code> rule:</p>
<pre><code>def get_seg_filenames(wildcards):
  filename = checkpoints.filter.get().output[0]
  df = pd.read_csv(filename)
  ark_ids = df["arkID"].tolist()
  return expand('Segmented/{arkID}_segmented.png', arkID=ark_ids)

rule summary:
  input:
     script="Scripts/SummaryReport.R",
     segmented=get_seg_filenames
  output: config["summary_report"]
  container: "docker://ghcr.io/rocker-org/tidyverse:4.2.2"
  shell: "Rscript {input.script}"</code></pre>
<p>Run snakemake to create the summary/report.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-c1</span> <span class="at">--use-singularity</span> <span class="at">--dry-run</span></span></code></pre>
</div></section><section id="aio-12_run_on_slurm"><p>Content from <a href="12_run_on_slurm.html">Run at Scale</a></p>
<hr>
<p> Last updated on 2023-03-20 | 
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/episodes/12_run_on_slurm.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I efficently scale up my workflow in a cluster?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Add a memory requirement to a rule</li>
<li>View a generic sbatch script to run a workflow at scale</li>
<li>Run the workflow at scale</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="running-with-slurm"><h2 class="section-heading">Running with Slurm<a class="anchor" aria-label="anchor" href="#running-with-slurm"></a>
</h2>
<hr class="half-width">
<ul>
<li>Ensure rules request appropriate resources
<ul>
<li>threads/cpus</li>
<li>memory</li>
<li>requires a gpu</li>
</ul>
</li>
<li>Configure snakemake to submit slurm jobs</li>
<li>Run main snakemake job in a background job</li>
</ul>
<p>See <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#threads" class="external-link">Snakemake
threads/resources docs</a> for details on how to request different
resources such as threads, memory, and gpus.</p>
</section><section id="annotating-memory-requirements"><h2 class="section-heading">Annotating memory requirements<a class="anchor" aria-label="anchor" href="#annotating-memory-requirements"></a>
</h2>
<hr class="half-width">
<p>Update the reduce rule to request a specific amount of memory.</p>
<pre><code>rule reduce:
    input: "multimedia.csv"
    params: rows="11"
    output: "reduce/multimedia.csv"
    resources:
        mem_mb=200
    shell: "head -n {params.rows} {input} &gt; {output}"</code></pre>
</section><section id="review-sbatch-script"><h2 class="section-heading">Review sbatch script<a class="anchor" aria-label="anchor" href="#review-sbatch-script"></a>
</h2>
<hr class="half-width">
<p>The <code>run-workflow.sh</code> script was copied into your
<code>SnakemakeWorkflow</code> during the project setup step. Run the
following command to view it:</p>
<pre class="shell"><code>cat run-workflow.sh</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>#!/bin/bash
#SBATCH --account=PAS2136
#SBATCH --time=00:30:00
. Scripts/setup_env.sh
JOBS=10
snakemake --jobs $JOBS --use-singularity --profile slurm/</code></pre>
</div>
</section><section id="run-background-job-and-monitor-progress"><h2 class="section-heading">Run Background job and monitor progress<a class="anchor" aria-label="anchor" href="#run-background-job-and-monitor-progress"></a>
</h2>
<hr class="half-width">
<p>Run snakemake in the background scaling up</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> run-workflow.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 23985835</code></pre>
</div>
</section><section id="monitor-job"><h2 class="section-heading">Monitor job<a class="anchor" aria-label="anchor" href="#monitor-job"></a>
</h2>
<hr class="half-width">
<pre><code><span><span class="va">squeue</span> <span class="op">-</span><span class="va">u</span> <span class="op">$</span><span class="va">LOGNAME</span></span></code></pre>
<pre><code>tail -f slurm-&lt;sbatch_job_number&gt;.out</code></pre>
</section><section id="notice-new-job-logs"><h2 class="section-heading">Notice new job logs<a class="anchor" aria-label="anchor" href="#notice-new-job-logs"></a>
</h2>
<hr class="half-width">
<p>Where did my logs go?</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> logs/</span></code></pre>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
				<p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/Imageomics/snakemake-workshop/edit/main/README.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/Imageomics/snakemake-workshop/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a> 
        | <a href="https://github.com/Imageomics/snakemake-workshop/" class="external-link">Source</a></p>
				<p><a href="https://github.com/Imageomics/snakemake-workshop/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:john.bradley@duke.edu">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.14.0" class="external-link">sandpaper (0.14.0)</a>,
        <a href="https://github.com/carpentries/pegboard/tree/0.7.1" class="external-link">pegboard (0.7.1)</a>,
      and <a href="https://github.com/carpentries/varnish/tree/0.3.1" class="external-link">varnish (0.3.1)</a>.</p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
			<i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back to top"></i><br><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://Imageomics.github.io/snakemake-workshop/aio.html",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, workflows, Imageomics",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://Imageomics.github.io/snakemake-workshop/aio.html",
  "identifier": "https://Imageomics.github.io/snakemake-workshop/aio.html",
  "dateCreated": "2023-03-22",
  "dateModified": "2023-10-24",
  "datePublished": "2023-10-24"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

